!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(e=e||self).imageCompression=r()}(this,function(){"use strict";function _slicedToArray(e,r){return function _arrayWithHoles(e){if(Array.isArray(e))return e}(e)||function _iterableToArrayLimit(e,r){var t=[],n=!0,i=!1,a=void 0;try{for(var o,c=e[Symbol.iterator]();!(n=(o=c.next()).done)&&(t.push(o.value),!r||t.length!==r);n=!0);}catch(e){i=!0,a=e}finally{try{n||null==c.return||c.return()}finally{if(i)throw a}}return t}(e,r)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var e="undefined"!=typeof window&&window.cordova&&window.cordova.require("cordova/modulemapper"),r=e&&e.getOriginalSymbol(window,"File")||File,t=e&&e.getOriginalSymbol(window,"FileReader")||FileReader;function getDataUrlFromFile(e){return new Promise(function(r,n){var i=new t;i.onload=function(){return r(i.result)},i.onerror=function(e){return n(e)},i.readAsDataURL(e)})}function getFilefromDataUrl(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Date.now();return new Promise(function(n){for(var i=e.split(","),a=i[0].match(/:(.*?);/)[1],o=atob(i[1]),c=o.length,u=new Uint8Array(c);c--;)u[c]=o.charCodeAt(c);var s=new Blob([u],{type:a});s.name=r,s.lastModified=t,n(s)})}function loadImage(e){return new Promise(function(r,t){var n=new Image;n.onload=function(){return r(n)},n.onerror=function(e){return t(e)},n.src=e})}function drawImageInCanvas(e){var r=_slicedToArray(getNewCanvasAndCtx(e.width,e.height),2),t=r[0];return r[1].drawImage(e,0,0,t.width,t.height),t}function drawFileInCanvas(e){return new Promise(function(r,t){var n,i,a=function $Try_1_Post(){try{return i=drawImageInCanvas(n),r([n,i])}catch(e){return t(e)}},o=function $Try_1_Catch(r){try{return getDataUrlFromFile(e).then(function(e){try{return loadImage(e).then(function(e){try{return n=e,a()}catch(e){return t(e)}},t)}catch(e){return t(e)}},t)}catch(e){return t(e)}};try{return createImageBitmap(e).then(function(e){try{return n=e,a()}catch(e){return o()}},o)}catch(e){o()}})}function canvasToFile(e,r,t,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;return new Promise(function(a,o){var c;return"function"==typeof OffscreenCanvas&&e instanceof OffscreenCanvas?e.convertToBlob({type:r,quality:i}).then(function(e){try{return(c=e).name=t,c.lastModified=n,$If_4.call(this)}catch(e){return o(e)}}.bind(this),o):getFilefromDataUrl(e.toDataURL(r,i),t,n).then(function(e){try{return c=e,$If_4.call(this)}catch(e){return o(e)}}.bind(this),o);function $If_4(){return a(c)}})}function getExifOrientation(e){return new Promise(function(r,n){var i=new t;i.onload=function(e){var t=new DataView(e.target.result);if(65496!=t.getUint16(0,!1))return r(-2);for(var n=t.byteLength,i=2;i<n;){if(t.getUint16(i+2,!1)<=8)return r(-1);var a=t.getUint16(i,!1);if(i+=2,65505==a){if(1165519206!=t.getUint32(i+=2,!1))return r(-1);var o=18761==t.getUint16(i+=6,!1);i+=t.getUint32(i+4,o);var c=t.getUint16(i,o);i+=2;for(var u=0;u<c;u++)if(274==t.getUint16(i+12*u,o))return r(t.getUint16(i+12*u+8,o))}else{if(65280!=(65280&a))break;i+=t.getUint16(i,!1)}}return r(-1)},i.onerror=function(e){return n(e)},i.readAsArrayBuffer(e)})}function handleMaxWidthOrHeight(e,r){var t,n=e.width,i=e.height,a=r.maxWidthOrHeight,o=e;if(Number.isInteger(a)&&(n>a||i>a)){var c=_slicedToArray(getNewCanvasAndCtx(n,i),2);o=c[0],t=c[1],n>i?(o.width=a,o.height=i/n*a):(o.width=n/i*a,o.height=a),t.drawImage(e,0,0,o.width,o.height)}return o}function followExifOrientation(e,r){var t=e.width,n=e.height,i=_slicedToArray(getNewCanvasAndCtx(t,n),2),a=i[0],o=i[1];switch(4<r&&r<9?(a.width=n,a.height=t):(a.width=t,a.height=n),r){case 2:o.transform(-1,0,0,1,t,0);break;case 3:o.transform(-1,0,0,-1,t,n);break;case 4:o.transform(1,0,0,-1,0,n);break;case 5:o.transform(0,1,1,0,0,0);break;case 6:o.transform(0,1,-1,0,n,0);break;case 7:o.transform(0,-1,-1,0,n,t);break;case 8:o.transform(0,-1,1,0,0,t)}return o.drawImage(e,0,0,t,n),a}function getNewCanvasAndCtx(e,r){var t,n;try{n=(t=new OffscreenCanvas(e,r)).getContext("2d")}catch(e){n=(t=document.createElement("canvas")).getContext("2d")}return t.width=e,t.height=r,[t,n]}function compress(e,r){return new Promise(function(t,n){var i,a,o,c,u,s,f;return i=r.maxIteration||10,a=1024*r.maxSizeMB*1024,drawFileInCanvas(e).then(function(l){try{var d=_slicedToArray(l,2);return o=d[0],c=handleMaxWidthOrHeight(c=d[1],r),new Promise(function(t,n){var i;if(!(i=r.exifOrientation))return getExifOrientation(e).then(function(e){try{return i=e,$If_2.call(this)}catch(e){return n(e)}}.bind(this),n);function $If_2(){return t(i)}return $If_2.call(this)}).then(function(l){try{return r.exifOrientation=l,c=followExifOrientation(c,r.exifOrientation),u=1,canvasToFile(c,e.type,e.name,e.lastModified,u).then(function(r){try{var l,d=function $Loop_3(){if(i--&&f.size>a){var r,t,s,l=_slicedToArray(getNewCanvasAndCtx(r=.9*c.width,t=.9*c.height),2);return s=l[0],l[1].drawImage(o,0,0,r,t),"image/jpeg"===e.type&&(u*=.9),canvasToFile(s,e.type,e.name,e.lastModified,u).then(function(e){try{return f=e,c=s,$Loop_3}catch(e){return n(e)}},n)}return[1]},h=function $Loop_3_exit(){return t(f)};return(s=r).size<=a?t(s):(f=s,(l=function(e){for(;e;){if(e.then)return void e.then(l,n);try{if(e.pop){if(e.length)return e.pop()?h.call(this):e;e=d}else e=e.call(this)}catch(e){return n(e)}}}.bind(this))(d))}catch(e){return n(e)}}.bind(this),n)}catch(e){return n(e)}}.bind(this),n)}catch(e){return n(e)}}.bind(this),n)})}var n,i=0;var a=function createWorker(e){return new Worker(URL.createObjectURL(new Blob(["(".concat(e,")()")])))}(function(){var e=!1;self.addEventListener("message",function(r){return new Promise(function(t,n){var i,a,o,c,u=r.data;i=u.file,a=u.id,o=u.imageCompressionLibUrl,c=u.options;var s=function $Try_1_Post(){try{return t()}catch(e){return n(e)}},f=function $Try_1_Catch(e){try{return self.postMessage({error:e.message,id:a}),s()}catch(e){return n(e)}};try{var l;return e||(importScripts(o),e=!0),imageCompression(i,c).then(function(e){try{return l=e,self.postMessage({file:l,id:a}),s()}catch(e){return f(e)}},f)}catch(e){f(e)}})})});function imageCompression(e,t){return new Promise(function(o,c){var u,s;if(t.maxSizeMB=t.maxSizeMB||Number.POSITIVE_INFINITY,t.useWebWorker="boolean"!=typeof t.useWebWorker||t.useWebWorker,!(e instanceof Blob||e instanceof r))return c(new Error("The file given is not an instance of Blob or File"));if(!/^image/.test(e.type))return c(new Error("The file given is not an image"));if(s="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,!t.useWebWorker||"function"!=typeof Worker||s)return compress(e,t).then(function(e){try{return u=e,$If_3.call(this)}catch(e){return c(e)}}.bind(this),c);var f=function(){try{return $If_3.call(this)}catch(e){return c(e)}}.bind(this),l=function $Try_1_Catch(r){try{return console.warn("Run compression in web worker failed:",r,", fall back to main thread"),compress(e,t).then(function(e){try{return u=e,f()}catch(e){return c(e)}},c)}catch(e){return c(e)}};try{return function compressOnWebWorker(e,r){return new Promise(function(t,o){return new Promise(function(c,u){if(!n){if(!("undefined"!=typeof document&&"currentScript"in document))return c(o(new Error("Cannot obtain library url to be loaded in web worker")));n=document.currentScript.src}var s=i++;return a.addEventListener("message",function handler(e){e.data.id===s&&(a.removeEventListener("message",handler),e.data.error&&o(e.data.error),t(e.data.file))}),a.postMessage({file:e,id:s,imageCompressionLibUrl:n,options:r}),c()})})}(e,t).then(function(e){try{return u=e,f()}catch(e){return l(e)}},l)}catch(e){l(e)}function $If_3(){try{u.name=e.name,u.lastModified=e.lastModified}catch(e){}return o(u)}})}return imageCompression.getDataUrlFromFile=getDataUrlFromFile,imageCompression.getFilefromDataUrl=getFilefromDataUrl,imageCompression.loadImage=loadImage,imageCompression.drawImageInCanvas=drawImageInCanvas,imageCompression.drawFileInCanvas=drawFileInCanvas,imageCompression.canvasToFile=canvasToFile,imageCompression.getExifOrientation=getExifOrientation,imageCompression.handleMaxWidthOrHeight=handleMaxWidthOrHeight,imageCompression.followExifOrientation=followExifOrientation,imageCompression});
//# sourceMappingURL=browser-image-compression.js.map
